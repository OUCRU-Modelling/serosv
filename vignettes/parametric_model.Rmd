---
title: "Parametric models"
output: rmarkdown::html_vignette
bibliography: references.bib
link-citations: TRUE
vignette: >
  %\VignetteIndexEntry{Parametric models}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, output=FALSE, warning=FALSE, message=FALSE}
library(serosv)
library(dplyr)
library(magrittr)
```

# Frequentist methods

## Polynomial models

Refer to `Chapter 6.1.1` of the book by @Hens2012 for a more detailed explanation of the methods.

Use `polynomial_model()` to fit a polynomial model.

We will use the `Hepatitis A` data from Belgium 1993--1994 for this example.

```{r}
data <- hav_bg_1964
```

### Muench model

**Proposed model**

[@muench_derivation_1934] suggested to model the infection process with so-called "catalytic model", in which the distribution of the time spent in the susceptible class in SIR model is exponential with rate $\beta$

$$
\pi(a) = k(1 - e^{-\beta a} )
$$

Where:

-   $\pi$ is the seroprevalence at age $a$
-   $1 - k$ is the proportion of population that stay uninfected for a lifetime
-   $a$ is the variable age

Under this catalytic model and assuming that $k = 1$, force infection would be $\lambda(a) = \beta$

**Fitting data**

**Muench**'s model can be estimated by either defining `k = 1` (a degree one linear predictor, note that it is irrelevant to the k in the proposed model) or setting the `type = "Muench"`.

```{r}
muench1 <- polynomial_model(data, k = 1)
summary(muench1$info)

muench2 <- polynomial_model(data, type = "Muench")
summary(muench2$info)
```

We can plot any model with the `plot()` function.

```{r}
plot(muench2) 
```

### Griffith model

**Proposed model**

Griffith proposed a model for force of infection as followed

$$
 \lambda(a) = \beta_1 + 2\beta_2a  
$$

Which can be estimated using a GLM where the for which the linear predictor was $\eta(a) = \beta_1a + \beta_2a^{2}$

**Fitting data**

Similarly, we can estimate **Griffith**'s model either by defining `k = 2`, or setting the `type = "Griffith"`

```{r}
gf_model <- polynomial_model(data, type = "Griffith")
plot(gf_model)
```

### Grenfell and Anderson model

**Proposed model**

[@grenfell_estimation_1985] extended the models of Muench and Griffiths further suggest the use of higher order polynomial functions to model the force of infection which assumes prevalence model as followed

$$
\pi(a)  = 1 - e^{-\Sigma_i \beta_i a^i}
$$

Which implies that force of infection equals $\lambda(a) = \Sigma \beta_i i a^{i-1}$

**Fitting data**

And Grenfell and Anderson's model.

```{r}
grf_model <- polynomial_model(data, type = "Grenfell")
plot(grf_model)
```

------------------------------------------------------------------------

## Nonlinear models

Refer to `Chapter 6.1.2` of the book by @Hens2012 for a more detailed explanation of the methods.

### Farrington model

**Proposed model**

For Farrington's model, the force of infection was defined non-negative for all a $\lambda(a) \geq 0$ and increases to a peak in a linear fashion followed by an exponential decrease

$$
\lambda(a) = (\alpha a - \gamma)e^{-\beta a} + \gamma
$$

Where $\gamma$ is called the long term residual for FOI, as $a \rightarrow \infty$ , $\lambda (a) \rightarrow \gamma$

Integrating $\lambda(a)$ would results in the following non-linear model for prevalence

$$
\pi (a) = 1 - e^{-\int_0^a \lambda(s) ds} \\ = 1 - exp\{ \frac{\alpha}{\beta}ae^{-\beta a} + \frac{1}{\beta}(\frac{\alpha}{\beta} - \gamma)(e^{-\beta a} - 1) -\gamma a \}
$$

**Fitting data**

Use `farrington_model()` to fit a **Farrington**'s model.

```{r, warning=FALSE}
farrington_md <- farrington_model(
   rubella_uk_1986_1987,
   start=list(alpha=0.07,beta=0.1,gamma=0.03)
   )
plot(farrington_md)
```

### Weibull model

**Proposed model**

For a Weibull model, the prevalence is given by

$$
\pi (d) = 1 - e^{ - \beta_0 d ^ {\beta_1}} 
$$

Where $d$ is exposure time (difference between age of injection and age at test)

The model was reformulated as a GLM model with log - log link and linear predictor using log(d)

$$\eta(d) = log(\beta_0) + \beta_1 log(d)$$

Thus implies that the force of infection is a monotone function of the exposure time as followed

$$
\lambda(d) = \beta_0 \beta_1 d^{\beta_1 - 1}
$$

**Fitting data**

Use `weibull_model()` to fit a Weibull model.

```{r}
hcv <- hcv_be_2006[order(hcv_be_2006$dur), ]

wb_md <- hcv %>% 
  rename(
    t = dur, status = seropositive
  ) %>% weibull_model()
plot(wb_md) 
```

------------------------------------------------------------------------

## Fractional polynomial model

Refer to `Chapter 6.2` of the book by @Hens2012 for a more detailed explanation of the methods.

**Proposed model**

Fractional polynomial model generalize conventional polynomial class of functions. In the context of binary responses, a fractional polynomial of degree $m$ for the linear predictor is defined as followed

$$
\eta_m(a, \beta, p_1, p_2, ...,p_m) = \Sigma^m_{i=0} \beta_i H_i(a)
$$

Where $m$ is an integer, $p_1 \le p_2 \le... \le p_m$ is a sequence of powers, and $H_i(a)$ is a transformation given by

$$
H_i = \begin{cases}
 a^{p_i} & \text{ if } p_i \neq p_{i-1},
 \\ H_{i-1}(a) \times log(a)  & \text{ if } p_i = p_{i-1},
\end{cases}
$$

**Best power selection**

Use `find_best_fp_powers()` to find the powers which gives the lowest deviance score

```{r, warning=FALSE}
hav <- hav_be_1993_1994
best_p <- find_best_fp_powers(
  hav,
  p=seq(-2,3,0.1), mc=FALSE, degree=2, link="cloglog"
)
best_p
```

**Fitting data**

Use `fp_model()` to fit a fractional polynomial model

```{r}
model <- fp_model(hav, p=c(1.5, 1.6), link="cloglog")
plot(model)
```

# Bayesian methods

**Proposed approach**

Prevalence has a parametric form $\pi(a_i, \alpha)$ where $\alpha$ is a parameter vector

One can constraint the parameter space of the prior distribution $P(\alpha)$ in order to achieve the desired monotonicity of the posterior distribution $P(\pi_1, \pi_2, ..., \pi_m|y,n)$

Where:

-   $n = (n_1, n_2, ..., n_m)$ and $n_i$ is the sample size at age $a_i$

-   $y = (y_1, y_2, ..., y_m)$ and $y_i$ is the number of infected individual from the $n_i$ sampled subjects

## Farrington

Refer to `Chapter 10.3.1` of the book by @Hens2012 for a more detailed explanation of the method.

**Proposed model**

The model for prevalence is as followed

$$
\pi (a) = 1 - exp\{ \frac{\alpha_1}{\alpha_2}ae^{-\alpha_2 a} + \frac{1}{\alpha_2}(\frac{\alpha_1}{\alpha_2} - \alpha_3)(e^{-\alpha_2 a} - 1) -\alpha_3 a \}
$$

For likelihood model, independent binomial distribution are assumed for the number of infected individuals at age $a_i$

$$
y_i \sim Bin(n_i, \pi_i), \text{  for } i = 1,2,3,...m
$$

The constraint on the parameter space can be incorporated by assuming truncated normal distribution for the components of $\alpha$, $\alpha = (\alpha_1, \alpha_2, \alpha_3)$ in $\pi_i = \pi(a_i,\alpha)$

$$
\alpha_j \sim \text{truncated  } \mathcal{N}(\mu_j, \tau_j), \text{ } j = 1,2,3
$$

The joint posterior distribution for $\alpha$ can be derived by combining the likelihood and prior as followed

$$
P(\alpha|y) \propto \prod^m_{i=1} \text{Bin}(y_i|n_i, \pi(a_i, \alpha)) \prod^3_{i=1}-\frac{1}{\tau_j}\text{exp}(\frac{1}{2\tau^2_j} (\alpha_j - \mu_j)^2)
$$

-   Where the flat hyperprior distribution is defined as followed:

    -   $\mu_j \sim \mathcal{N}(0, 10000)$

    -   $\tau^{-2}_j \sim \Gamma(100,100)$

The full conditional distribution of $\alpha_i$ is thus $$
P(\alpha_i|\alpha_j,\alpha_k, k, j \neq i) \propto  -\frac{1}{\tau_i}\text{exp}(\frac{1}{2\tau^2_i} (\alpha_i - \mu_i)^2) \prod^m_{i=1} \text{Bin}(y_i|n_i, \pi(a_i, \alpha))
$$

**Fitting data**

To fit Farrington model, use `hierarchical_bayesian_model()` and define `type = "far2"` or `type = "far3"` where

-   `type = "far2"` refers to Farrington model with 2 parameters ($\alpha_3 = 0$)

-   `type = "far3"` refers to Farrington model with 3 parameters ($\alpha_3 > 0$)

```{r}
df <- mumps_uk_1986_1987
model <- hierarchical_bayesian_model(df, type="far3")

model$info
plot(model)
```

## Log-logistic

**Proposed approach**

The model for seroprevalence is as followed

$$
\pi(a) = \frac{\beta a^\alpha}{1 + \beta a^\alpha}, \text{ } \alpha, \beta > 0
$$

The likelihood is specified to be the same as Farrington model ($y_i \sim Bin(n_i, \pi_i)$) with

$$
\text{logit}(\pi(a)) = \alpha_2 + \alpha_1\log(a)
$$

-   Where $\alpha_2 = \text{log}(\beta)$

The prior model of $\alpha_1$ is specified as $\alpha_1 \sim \text{truncated  } \mathcal{N}(\mu_1, \tau_1)$ with flat hyperprior as in Farrington model

$\beta$ is constrained to be positive by specifying $\alpha_2 \sim \mathcal{N}(\mu_2, \tau_2)$

The full conditional distribution of $\alpha_1$ is thus

$$
P(\alpha_1|\alpha_2) \propto -\frac{1}{\tau_1} \text{exp} (\frac{1}{2 \tau_1^2} (\alpha_1 - \mu_1)^2)
\prod_{i=1}^m \text{Bin}(y_i|n_i,\pi(a_i, \alpha_1, \alpha_2) )
$$

And $\alpha_2$ can be derived in the same way

**Fitting data**

To fit Log-logistic model, use `hierarchical_bayesian_model()` and define `type = "log_logistic"`

```{r}
df <- rubella_uk_1986_1987
model <- hierarchical_bayesian_model(df, type="log_logistic")

model$type
plot(model)
```
