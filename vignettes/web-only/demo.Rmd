---
title: "serosv: model infectious disease parameters from serosurveys"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  out.width = "100%",
  dpi = 300,
  warning = F,
  fig.width = 6,
  fig.height = 4
)
library(serosv)
```

Here we demonstrate how to use `serosv` to estimate the seroprevalence and force of infection using some built-in datasets.

## Polynomial models 

Refer to `Chapter 6.1.1`

Use `polynomial_model()` to fit a polynomial model.

We will use the `Hepatitis A` data from Belgium 1993--1994 for this example.

```{r}
a <- hav_bg_1964
neg <- a$tot -a$pos
pos <- a$pos
age <- a$age
tot <- a$tot
```

### Muench model

**Muench**'s model can be estimated by either defining `k = 1` (a degree one linear predictor) or setting the `type = "Muench"`.

```{r}
muench1 <- polynomial_model(age, pos, neg, k = 1)
summary(muench1$info)

muench2 <- polynomial_model(age, pos, neg, type = "Muench")
summary(muench2$info)
```

We can plot any model with the `plot()` function.

```{r}
plot(muench2) 
```

### Griffith model

Similarly, we can estimate **Griffith**'s model.

```{r}
gf_model <- polynomial_model(age, pos, neg, type = "Griffith")
plot(gf_model)
```

### Grenfell and Anderson model

And Grenfell and Anderson's model.

```{r}
grf_model <- polynomial_model(age,pos,neg,type = "Grenfell")
plot(grf_model)
```

## Nonlinear models

Refer to `Chapter 6.1.2`

### Farrington model

Use `farrington_model()` to fit a **Farrington**'s model.

```{r}
rubella <- rubella_uk_1986_1987
rubella$neg <- rubella$tot - rubella$pos

farrington_md <- farrington_model(
   rubella$age, rubella$pos, rubella$tot,
   start=list(alpha=0.07,beta=0.1,gamma=0.03)
   )
plot(farrington_md)
```

### Weibull model

Use `weibull_model()` to fit a Weibull model.

```{r}
hcv <- hcv_be_2006[order(hcv_be_2006$dur), ]
dur <- hcv$dur
infected <- hcv$seropositive

wb_md <- weibull_model(
   t = dur,
   spos = infected
   )
plot(wb_md) 
```

## Fractional polynomial model

Refer to `Chapter 6.2`

Use `find_best_fp_powers()` to find the powers which gives the lowest deviance score

```{r}
hav <- hav_be_1993_1994
best_p <- find_best_fp_powers(
  hav$age, hav$pos, hav$tot,
  p=seq(-2,3,0.1), mc=FALSE, degree=2, link="cloglog"
)
best_p
```

Use `fp_model()` to fit a fractional polynomial model

```{r}
model <- fp_model(
  hav$age, hav$pos, hav$tot,
  p=c(1.5, 1.6), link="cloglog")
plot(model)
```

## Nonparametric model

Refer to `Chapter 7.1`

### Local estimation by polynomial

```{r}
mump <- mumps_uk_1986_1987
age <- mump$age
pos <- mump$pos
tot <- mump$tot
y <- pos/tot
```

Use `plot_gcv()` to show GCV curves for the nearest neighbor method (left) and constant bandwidth (right).

```{r, fig.width=7, fig.height=3}
plot_gcv(
   age, pos, tot,
   nn_seq = seq(0.2, 0.8, by=0.1),
   h_seq = seq(5, 25, by=1)
 )
```

Use `lp_model()` to fit a local estimation by polynomials.

```{r}
lp <- lp_model(age, pos, tot, kern="tcub", nn=0.7, deg=2)
plot(lp)
```

## Semiparametric models

### Penalized likelihood

```{r}

```

### Generalized likelihood framework

```{r}

```

## Hierarchical Bayesian model

## Fitting quantitative data

## Modeling Multivariate serological data

Fitting bivariate Dale model using `bivariate_dale_model()`

We will use `rubella_mumps_uk` data for this example

```{r}
data <- rubella_mumps_uk
model <- bivariate_dale_model(age = data$age, y = data[, c("NN", "NP", "PN", "PP")], monotonized=TRUE)
```

plot function for `bivariate_dale_model` object takes 3 additional parameters:

-   `y1` and `y2` are labels for 2 diseases being modeled

-   `plot_type` is for the type of plot being returned

    -   `"ci"` returns fitted line for marginal prevalence and its 95% confidence interval

    -   `"sp"` returns conditional and joint seroprevalence and FOI

    -   other inputs would returns all individual plots

```{r, fig.width=7, fig.height=4}
plot(model, y1 = "Rubella", y2 = "Mumps", plot_type = "ci")
```

For line listing data `vzv_parvo_be` , use `generate_quad_matrix()` function to create the (NN, NP, PN, PP) for fitting the model

```{r, eval = F}
generate_quad_matrix(vzv_parvo_be, vzv_res, parvo_res, age, discrete_age = F)
```

## Estimating Age-Time Dependent Prevalence
